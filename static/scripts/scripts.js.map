{"version":3,"names":[],"mappings":"","sources":["scripts.js"],"sourcesContent":["'use strict';\r\n/**\r\n * Doc Ready\r\n * 就是 $.(document).ready(function(){})\r\n */\r\nfunction docReady(fn) {\r\n    if (document.readyState != 'loading') {\r\n        fn();\r\n    } else {\r\n        document.addEventListener('DOMContentLoaded', fn);\r\n    }\r\n}\r\n\r\n/**\r\n * Get Element\r\n * 就是 $(element)\r\n */\r\nfunction getEl(element) {\r\n    let tempEl;\r\n    switch ([...element][0]) {\r\n        case '#':\r\n            tempEl = document.querySelectorAll(element)[0];\r\n            break;\r\n        default:\r\n            tempEl = document.querySelectorAll(element);\r\n    };\r\n    return tempEl;\r\n}\r\n\r\n/**\r\n * My ajax\r\n * 自写的一个稀烂的 Ajax 函数\r\n */\r\nfunction myAjax({\r\n    method = 'GET',\r\n    url = undefined,\r\n    data,\r\n    async = true,\r\n    user = null,\r\n    password = null,\r\n    type = '',\r\n    done = () => { },\r\n    fail = () => { },\r\n    always = () => { },\r\n    error = () => { },\r\n    timeout = undefined,\r\n    timeoutEvent = () => { },\r\n    beforeSend = () => { },\r\n}) {\r\n\r\n    let xhr = new XMLHttpRequest();\r\n    xhr.open(method, url, async, user, password);\r\n    xhr.responseType = type;\r\n    beforeSend(this);\r\n    xhr.onload = function () {\r\n        if (xhr.status >= 200 && xhr.status < 300) {\r\n            done(this);\r\n        } else {\r\n            fail(this);\r\n        }\r\n        always(this);\r\n    }\r\n    xhr.onerror = function () {\r\n        error(this);\r\n        always(this);\r\n    }\r\n    timeout = Number(timeout);\r\n    if (!Number.isNaN(timeout) && Number.isInteger(timeout)) {\r\n        xhr.timeout = timeout;\r\n        xhr.ontimeout = function () {\r\n            timeoutEvent(this);\r\n            xhr.abort();\r\n            always(this);\r\n        }\r\n    }\r\n    if (data) {\r\n        xhr.send(data);\r\n    } else {\r\n        xhr.send();\r\n    }\r\n};\r\n// 下面才是正文\r\nconsole.log('script.js 已载入');\r\ndocReady(() => {\r\n    let\r\n        设置 = {},\r\n        载入的JSON = [],\r\n        抽奖歌单 = [],\r\n        歌单名 = {\r\n            'maimaidxplus': 'maimaiDX+ 日版',\r\n            'maimaidxCN': 'maimaiDX CN（新基准）'\r\n        },\r\n        分类名 = {\r\n            'pops_anime': '动画 & 流行',\r\n            'niconico': 'nico & V家',\r\n            'toho': '东方 Project',\r\n            'variety': '游戏 & 联动',\r\n            'maimai': 'maimai 原创',\r\n            'gekichu': '音击 & 中二',\r\n            'original': '原创曲目'\r\n        },\r\n        难度名 = {\r\n            All: '全难度',\r\n            B: 'Basic',\r\n            A: 'Advanced',\r\n            E: 'Expert',\r\n            M: 'Master',\r\n            R: 'Re:Master'\r\n        };\r\n    //#region 载入歌单\r\n    function 载入歌单(文件名, 版本 = 1) {\r\n        let 载入次数;\r\n        myAjax({\r\n            type: 'GET',\r\n            url: './data/' + 文件名 + '.json?ver=' + 版本,\r\n            timeout: 10000,\r\n            type: 'json',\r\n            done: (data) => {\r\n                console.log(data.response);\r\n                载入的JSON[文件名] = data.response;\r\n                console.log('载入的JSON:', 载入的JSON);\r\n            },\r\n            fail: () => {\r\n                if (载入次数 < 10) {\r\n                    载入次数++;\r\n                    载入歌单(文件名, 版本);\r\n                    console.log('载入文件失败：' + 文件名 + '（' + 版本 + '），失败次数：' + 载入次数);\r\n                } else {\r\n                    alert(文件名 + '.json' + '（' + 版本 + '）' + '载入失败次数过多，请刷新页面重试');\r\n                    载入次数 = 0;\r\n                }\r\n            }\r\n        });\r\n    }\r\n    载入歌单('maimaidxCN', 1);\r\n    载入歌单('maimaidxplus', 1);\r\n    //#endregion\r\n    let\r\n        Roll歌按钮 = getEl('#roll-button');\r\n    Roll歌按钮.setAttribute('disabled', 'disabled');\r\n    //#region 设置\r\n    let 设置按钮 = getEl('#setting-button');\r\n    let 保存设置 = getEl('#save-option');\r\n    设置按钮.addEventListener('click', () => {\r\n        getEl('.option-main')[0].classList.add('show');\r\n    });\r\n    let 表单 = getEl('#option-form');\r\n    表单.addEventListener('submit', function (event) {\r\n        let\r\n            等级 = getEl('#lv').value,\r\n            等级带加号 = getEl('#lv-plus').checked,\r\n            表单数据 = new FormData(this);\r\n        console.log('表单数据：', 表单数据);\r\n\r\n        if (!(Number(等级) > 0) || isNaN(Number(等级))) {\r\n            console.log('设置有误');\r\n            console.log('等级：', 等级);\r\n\r\n            console.log(Number(等级));\r\n            console.log(isNaN(Number(等级)));\r\n\r\n            // event.preventDefault();\r\n            return false;\r\n        }\r\n        // 清空一下设置，不然会有残留\r\n        设置 = {};\r\n        for (let [key, value] of 表单数据.entries()) {\r\n            设置[key] = value;\r\n        }\r\n        getEl('.option-main')[0].classList.remove('show');\r\n        Roll歌按钮.removeAttribute('disabled');\r\n\r\n        console.log('设置：', 设置);\r\n\r\n        if (设置.等级带加号) {\r\n            getEl('#setting-lv').textContent = `[${难度名[设置.难度]}] ${设置.等级}+`;\r\n        } else {\r\n            getEl('#setting-lv').textContent = `[${难度名[设置.难度]}] ${设置.等级}`;\r\n        }\r\n        getEl('#setting-songlist').textContent = 歌单名[设置.歌单];\r\n\r\n        // 筛选歌曲\r\n        抽奖歌单 = 载入的JSON[设置.歌单].曲目列表;\r\n        console.log('筛选前的抽奖歌单：', 抽奖歌单);\r\n        function 筛选歌单(歌曲) {\r\n            let\r\n                result = false,\r\n                lv = 设置.等级;\r\n            let tempLv = Object.values(歌曲.等级);\r\n            if (设置.等级带加号) {\r\n                lv = lv + '+';\r\n            }\r\n            if (设置.难度 == 'all') {\r\n                tempLv.some((value) => {\r\n                    if (value == lv) {\r\n                        result = true;\r\n                    }\r\n                    // console.log('Result:', result);\r\n                });\r\n            } else {\r\n                if (歌曲.等级[设置.难度] == lv) {\r\n                    result = true;\r\n                }\r\n            }\r\n            return result;\r\n        }\r\n        抽奖歌单 = 抽奖歌单.filter(筛选歌单);\r\n        // 打乱一下歌单，避免浏览器的伪随机影响\r\n        shuffleArray(抽奖歌单);\r\n        console.log('筛选后的抽奖歌单：', 抽奖歌单);\r\n\r\n        event.preventDefault();\r\n        return false;\r\n    });\r\n    //#endregion\r\n\r\n    // 打乱数组，来自：https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array\r\n    function shuffleArray(array) {\r\n        for (let i = array.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [array[i], array[j]] = [array[j], array[i]];\r\n        }\r\n    }\r\n\r\n    function 抽取(最小值, 最大值) {\r\n        let 抽取数 = 最大值 - 最小值 + 1;\r\n        return Math.floor(Math.random() * 抽取数 + 最小值);\r\n    }\r\n    // 来自：https://stackoverflow.com/questions/9907419/how-to-get-a-key-in-a-javascript-object-by-its-value\r\n    function getKeyByValue(object, value) {\r\n        return Object.keys(object).find(key => object[key] === value);\r\n    }\r\n\r\n    Roll歌按钮.addEventListener('click', () => {\r\n        console.log('Roll!');\r\n        let\r\n            随机数 = 抽取(0, 抽奖歌单.length - 1),\r\n            抽到的歌 = 抽奖歌单[随机数];\r\n        console.log(抽到的歌);\r\n        getEl('#title').textContent = 抽到的歌.曲名;\r\n        getEl('#category').textContent = 分类名[抽到的歌.分类];\r\n        let temp = {};\r\n        if (设置.等级带加号) {\r\n            temp.lv = 设置.等级 + '+';\r\n        } else {\r\n            temp.lv = 设置.等级;\r\n        }\r\n        temp.lvName = getKeyByValue(抽到的歌.等级, temp.lv);\r\n        getEl('#lv-name').classList.remove('B', 'A', 'E', 'M', 'R');\r\n        getEl('#lv-name').classList.add(temp.lvName);\r\n        getEl('#lv-name').textContent = 难度名[temp.lvName];\r\n        getEl('#lv-num').textContent = temp.lv;\r\n        getEl('#type').textContent = 抽到的歌.类型;\r\n        if (抽到的歌.封面 != '') {\r\n            getEl('#cover').setAttribute('src', `./static/img/cover/${抽到的歌.分类}/${抽到的歌.封面}.jpg`);\r\n        } else {\r\n            getEl('#cover').setAttribute('src', './static/img/nocover.png');\r\n        }\r\n        getEl('#table-lv-num-B').textContent = 抽到的歌.等级.B;\r\n        getEl('#table-lv-num-A').textContent = 抽到的歌.等级.A;\r\n        getEl('#table-lv-num-E').textContent = 抽到的歌.等级.E;\r\n        getEl('#table-lv-num-M').textContent = 抽到的歌.等级.M;\r\n        getEl('#table-lv-num-R').textContent = 抽到的歌.等级.R;\r\n    });\r\n});\r\n"],"file":"scripts.js"}